# nginx.conf

# 这是一个简单的Nginx配置文件，用于将静态文件服务和API请求代理到后端

# 定义用户，提高安全性
user nginx;

# worker进程的数量，通常设置为CPU核心数
worker_processes auto;

# 错误日志路径
error_log /var/log/nginx/error.log warn;

# PID文件路径
pid /var/run/nginx.pid;

events {
    # 每个worker进程可以处理的最大连接数
    worker_connections 1024;
}

http {
    # 启用MIME类型，以便Nginx知道如何服务文件
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    # 访问日志路径
    access_log /var/log/nginx/access.log main;

    # 启用gzip压缩
    gzip on;
    gzip_static on;
    gzip_min_length 1k;
    gzip_comp_level 5;
    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;

    # 定义一个upstream（上游）服务器，这里指向你的后端服务
    upstream backend_service {
        # backend是docker-compose.yaml中后端服务的名称
        # Nginx将使用这个名称在内部网络中解析到后端容器的IP地址
        server backend:8080;
    }

    server {
        # Nginx监听80端口
        listen 80;
        server_name localhost;

        # 根路径代理，用于服务Vue静态文件
        location / {
            # 网站根目录，指向容器中Vue构建后的静态文件目录
            root /usr/share/nginx/html;
            # 默认的索引文件
            index index.html index.htm;
            # 如果找不到文件，就返回index.html，这对于Vue Router的history模式是必需的
            try_files $uri $uri/ /index.html;
        }

        # API请求代理，将所有 /api 开头的请求转发给后端服务
        location /api {
            # 代理到之前定义的上游服务器
            proxy_pass http://backend_service;
            # 设置请求头，以确保后端能获取到真实的客户端IP等信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 错误页面配置
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
